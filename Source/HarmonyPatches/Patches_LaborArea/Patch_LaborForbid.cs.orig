using System;
using System.Collections.Generic;
using System.Linq;
using System.Reflection;
using System.Reflection.Emit;
using HarmonyLib;
using PrisonLabor.Core;
using RimWorld;
using Verse;
using Verse.AI;

namespace PrisonLabor.HarmonyPatches.Patches_LaborArea
{
    [HarmonyPatch(typeof(JobGiver_Work))]
    [HarmonyPatch("TryIssueJobPackage")]
    [HarmonyPatch(new[] { typeof(Pawn), typeof(JobIssueParams) })]
    internal class Patch_LaborForbid
    {
        private static IEnumerable<CodeInstruction> Transpiler(ILGenerator gen, MethodBase mBase,
            IEnumerable<CodeInstruction> instr)
        {
            // Temporary class for main loop
            OpCode[] opCodesClass =
{
                OpCodes.Ldloc_S,
            };
            string[] operandsClass =
            {
                "RimWorld.JobGiver_Work+<>c__DisplayClass3_1 (9)",
            };
            var tempClass = HPatcher.FindOperandAfter(opCodesClass, operandsClass, instr, true);

            // Scanner
            OpCode[] opCodesScanner =
{
                OpCodes.Ldfld,
            };
            string[] operandsScanner =
            {
                "RimWorld.WorkGiver_Scanner scanner",
            };
<<<<<<< Updated upstream
            var scanner = HPatcher.FindOperandAfter(opCodesScanner, operandsScanner, instr, true);
=======
            int step2 = 0;
            OpCode[] firstIfopCodes =
{
                OpCodes.Ldloc_S,
                OpCodes.Ldloc_S,
                OpCodes.Ldloc_S,
                OpCodes.Callvirt
            };
            String[] firstIfOperands =
{
                "RimWorld.JobGiver_Work+<>c__DisplayClass3_1 (9)",
                "System.Collections.Generic.IList`1[Verse.IntVec3] (19)",
                "System.Int32 (20)",
                "Verse.IntVec3 get_Item(Int32)"
            };
>>>>>>> Stashed changes

            // Fragment where cells are collected as IEnumerable
            OpCode[] opCodesFunc =
            {
                OpCodes.Callvirt,
            };
            string[] operandsFunc =
            {
                "System.Collections.Generic.IEnumerable`1[Verse.IntVec3] PotentialWorkCellsGlobal(Verse.Pawn)",
            };
            int stepFunc = 0;

            // Transpiler
            foreach (var instruction in instr)
            {
                yield return instruction;
                if (HPatcher.IsFragment(opCodesFunc, operandsFunc, instruction, ref stepFunc, "LaborForbid", true))
                {
                    yield return new CodeInstruction(OpCodes.Ldarg_1);
                    yield return new CodeInstruction(OpCodes.Ldloc_S, tempClass);
                    yield return new CodeInstruction(OpCodes.Ldfld, scanner);
                    yield return new CodeInstruction(OpCodes.Ldfld, typeof(WorkGiver).GetField("def"));
                    yield return new CodeInstruction(OpCodes.Ldfld, typeof(WorkGiverDef).GetField("workType"));
                    yield return new CodeInstruction(OpCodes.Call, typeof(Patch_LaborForbid).GetMethod("RemoveFromListForbiddenCells"));
                }

                if (HPatcher.IsFragment(firstIfopCodes, firstIfOperands, ci, ref step2, "Patch_LaborForbid_FirstIf"))
                {
                    yield return new CodeInstruction(OpCodes.Ldloc_S, cell);
                    yield return new CodeInstruction(OpCodes.Ldarg_1);
                    yield return new CodeInstruction(OpCodes.Ldloc_S, jobgiver);
                    yield return new CodeInstruction(OpCodes.Ldfld, scanner);
                    yield return new CodeInstruction(OpCodes.Call, typeof(Patch_LaborForbid).GetMethod((nameof(GetWorkType))));
                    yield return new CodeInstruction(OpCodes.Call, typeof(PrisonLaborUtility).GetMethod((nameof(PrisonLaborUtility.IsDisabledByLabor))));
                    yield return new CodeInstruction(OpCodes.Brtrue, HPatcher.FindOperandAfter(new[] { OpCodes.Callvirt }, new[] { "Void <TryIssueJobPackage>g__ProcessCell|3(Verse.IntVec3, <>c__DisplayClass3_2 ByRef)" }, instr));
                }
            }
        }

        public static IEnumerable<IntVec3> RemoveFromListForbiddenCells(IEnumerable<IntVec3> list, Pawn pawn, WorkTypeDef workType)
        {
            return list.Where(i => !PrisonLaborUtility.IsDisabledByLabor(i, pawn, workType));
        }

        public static void CustomFirstFor()
        {
            for (int k = 0; k < list2.Count; k++)
            {
                ProcessCell(list2[k]);
            }
        }
    }
}
